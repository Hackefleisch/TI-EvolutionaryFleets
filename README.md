# TI-EvolutionaryFleets
An attempt to find optimal fleet compositions for Fantasy Flights Twilight Imperium using evolutionary algorithms in a competitive enviroment


## Introduction
Twilight Imperium is a grand strategy board game based around up to 6 players using 17 different races in a struggle for power. The most obvious way to galactic control is using your fleets of space ships to overwhelm all of your enemies. These fleets can be composed of a variety of combinations of ships limited only by your availabe ressources and logistic capacities of your empire. Which fleet composition is best is very situational but with this project I will try to shine some light and maybe even find some generally good compositions using scientific methods.

Being a computer scientist myself I will try to hold up highest standards, but since this is just a fun little side project it might happen, that I am not spending all the requirde attention on every little detail. My main goal is to refresh my C++ skills, try evolutionary algorithms for the first time and maybe find some interesting results. Any thoughts, participation and criticism is highly appreciated.

### Fleets
As stated before, fleets are composed of a variety of ships of any valid combination. I am searching for a fleet compostion which proves to be very successfull in a competitive enviroment. This means I will simulate fleets, let them engage in combat and see, which are good and which not. These fleets will have two main limitations. First the overall costs of all ships combined. A map of a Twilight Imperium game provides roughly 60-70 ressources, more wealth can be generated through trade, so I assume that a hard cap at 40 total spent on one fleet is more than enough to represent realistic fleets. At the beginning of the simulation each fleet will start with ships up to a combined cost of 9 since this roughly around the average of combined costs of the factions starting fleets. From there they will use evolution to become more or less expensive.

The second limitation is the maximal number of capital ships in a fleet. A capital ship is every ship which is not a fighter, but I will explain ships a little bit more in depth later. With the exception of one faction, all factions start with 3 fleet logistic capacities, so this where the simulation will begin and we will see how it evolves. I will set 10 capital ships as a hard cap since I've never heard of fleets being bigger than 7 capital ships and it is quite an investment to build up such a big fleet logistic.

### Ships
While Twilight Imperium provides a big variety of upraged and faction specific ships I will only use the base ships for simplicity reasons. Upgraded or advanced ships might find their way into the simulation later but are off the table for now. All ships come with a set of 4 stats. Each ship has a cost, a combat value, a movement value and finally a capacity. Costs were discussed previously and are only taken into account for the combined costs of a fleet and for scoring, more on that later. The combat value describes the chance to produce a hit on an opposing ship. Combat will get covered in the next chapter. Movement depicts how far a ship can move over the board. This stat won't be used at all. It has for sure huge implications if a fleet or ship is fast within the game, but in this simulation I am only interested in heads on combat. Lastly many ships provide capacity. The combined capacity value describes how many ground troops or fighters can be taken with the fleet. Since I am only covering space battles, capacity will solely be used for fighters. As mentioned before, they don't count against the capital ship limit depicted by the fleet logistics. Furthermore fighters are the cheapest ship available in the game. So their main role is to absorb hits and protect the capital ships. 

##### List of basic ships in Twilight Imperium:
| Name        | Cost | Combat | Move | Capacity | Abilities                   |
|-------------|------|--------|------|----------|-----------------------------|
| Fighter     | 0.5  | 9      | -    | -        | None                        |
| Destroyer   | 1    | 9      | 2    | 0        | Anti-Fighter Barrage 9 (x2) |
| Cruiser     | 2    | 7      | 2    | 0        | None                        |
| Carrier     | 3    | 9      | 1    | 4        | None                        |
| Dreadnought | 4    | 5      | 1    | 1        | Sustain Damage              |
| War Sun     | 12   | 3 (x3) | 2    | 6        | Sustain Damage              |

To prevent confusion at this point, combat values range from 1 to 10 with 1 being a guaranteed hit and 10 being only a 10% chance to hit. As mentioned before, fighters are mostly there to absorb hits and prevent damage to the capital ships. Their main advantage is being cheap and not counting against the capital ship limit. Destroyers try to counter big fighter screens since their anti-fighter barrage allows them a chance to take down fighters before the battle actually begins. Cruisers are the first more beefy ships which provide a good chance to hit while still being fairly cheap. Carriers main job is to provide capacity for the fighter screens. Dreadnoughts are the core of a strong fighting fleet, at least in most games I've seen. They bring a lot firepower, can carry a fighter and with their sustain damage abiltiy they can take two hits instead of one before going down. War Suns are the biggest and scariest ships. As the only ship they fire 3 shots each round of battle instead of one, have a really high chance of hitting and can even bring 6 fighters as screening. This makes them also really expansive. An important note here is, that War Suns are actually not really basic ships since most factions need to research a lot technology before they can even build it. I include War Suns anyway because they don't have an upgraded version which makes comparison easier and I am really curious how well they perform. Also because of their high price now starting fleet will be able to include one.

### Space Battles
When two fleets engage in Twilight Imperium they start a space battle following and repeating a given sequence of phases. The combat itsel is decided by dice rolls with a 10 sided die.
1. Anti-Fighter Barrage: For each destroyer in his or her fleet each player throws two 10 sided dice. For each result of 9 or greater (9, 10) the opposing player has to remove one his or her fighters if able.
2. Announce Retreats: This step is skipped since I decided that all fleets will fight till the bitter end.
3. Roll dice: Each player rolls one 10 sided die for each ship (including fighters) that he or she controls at the same time. Each War Sun provides 3 instead of 1 dice. If the result is equal to or higher than the combat value, they produced a hit.
4. Assign hits: Each player has to assign each of the hits produced by their opponent to one of their ships which destroys the ship. Once per combat they can activate the sustain damage ability from War Suns or Dreadnoughts to cancel one hit per activated ability. You can imagine it like damaging but not destroying their super heavy ships. Usually players first use thei sustain damage abilities to bring as many ships as possible into the next round of combat. After that they assign hits to their fighters, since they perform bad in combat and are easily rebuild. Following that becomes more situational within the game.
5. Retreat: Also skipped.

After step 4 if there are ships on both sides left, the battle will continue with step 3 until at least one side is destroyed. Since combat rolls happen at the same time, mutual destruction is possible. Most of the explained steps don't require any player decision except for step 4. Within my simulation fleets will first use all their sustain damage abilities, then destroy fighters, then destroyers because of their low cost and combat values, then carriers because of their low combat values and then cruisers, dreadnoughts and finally War Suns to maintain the highest possible firepower at all time and destroy cheaper units when possible.

## Evolutionary Algorithms
Within computer science and other scientific topics you often encounter problems which search for complex solutions such as DNA alignment, permutation problmes and others. Often it is to complicated to calculate the best solution, so scientists came up with a wide variety of heurisitc approaches which provide a good answer but not necessarily the best answer. An example would be to just randomly guess solutions, always remembering only the best so far provided and stop guessing after a certain amount of time. Another and more sophisticated approach are evolutionary algorithms. The idea is to guess an initial set of solutions, called population, rank them by their quality with a fitness function, delete or kill a given amount of solutions from the population and use the remainders to create new solutions to replace the killed ones. During reproduction new solutions can mutate and be slightly different from their parents. This should slowly push the whole population towards optimal fitness functions, just as evolution did it in reality with organisms. I think, this is good approach to find optimal Twilight Imperium fleet compositions, since it provides theoretical a wide variety of opponents with which a fleet has to compete to be reliably good. A game of Twilight Imperium starts with small fleets and usually escalates in fleet size and costs during the game, while most fleet builds and compositions are a reaction to opposed threads by fleets from others players. So an enviroment where fleets are competing with each other and evolve as a reaction to battles should be a quite good simulation of the actual game flow.

### Initial Population
The simulation needs a random starting population of fleets. I decide to make populations of 1000 fleets. As mentioned befor, these initial fleets will be capped at combined costs of 9 and 3 capital ships maximum. They don't have to use all the capital ship places but will try to max out the costs. To create an initial fleet the computer will get a list of ships to buy which won't violate any of the opposed restrictions if added to the fleet. Each entry in the list will get the same possibility to be picked. Once a ship is picked, the list will get updated and the process continues until there is no choice left. For example the first list will contain all ships except War Suns because they are to expensive and fighters because the fleet is empty and provides no capacity. Fighters will join the list if any ship with capacity is picked and ships will leave the list if no capacity is left, their cost is higher than the left ressources to spend or there is no more room for capital ships.

### Fitness Function
The main concept of a fleets fitness is its perfomance in battle with other fleets. This area provides a lot of space for experiments. My first idea is that each fleet will fight five other fleets picked at random from the population one after another and being refreshed between fights. The results of each fight will only be scored for the currently active fleet. Each 1vs1 will be repeated five times to create more statistical relevance and flat out bad dice roll. So one round of scoring each fleet will take 1000 x 5 x 5 = 25000 fights. All these numbers are arbitrary and it is worth a thought to change the number of 1vs1 fights, fleets to engange and even think about scoring the results for all involved fleets not only the active one.

But how is a battle actually scored? The easiest way would be to count the battles won, but I think this is to simple. Twilight Imperium is not only about board control, but also about economy. So if you manage to impose a lot of damage with a cheap force on an expensive one but still lose the battle, your fleet actually performed really well. To reflect that I will try different other scoring mechanics. First, I will count the amount of ressources destroyed by a fleet in total and as a fraction of its opponents total cost. Second I will count the losses in ressources in total and as a fraction of its own costs. And lastly I will calculate how many resources a fleet destroyed in ratio with ressources spent on itself. The first two scores describe the economical damage dealt and taken, while the third should emphasize on assymetric fleets. When a player builds big expansive fleets he or she might not have sufficiant ressources elsewhere, so I want to punish fleets which a ridiculously big whilst the rest of the population is super small. Still I don't want to get completly rid of victory counts, since area control is still an important part of the game. I just want to explore a wide variety of scoring.

All of these scores should be normalized to a value between 0 and 1 and then combined linear with different weightings. The combined score shall be again normalized.

```
#win := number of won fights divided by number of fights fought
#dst := amount of ressources destroyed divided by hard cap on ressources for fleets (currently 40)
#tkn := amount of ressources lost divided by hard cap on ressources for fleets (currently 40)
%dst := amount of ressources destroyed divided by combined cost of opposing fleet
%tkn := amount of ressources lost divided by combined cost of itself
frct := amount of ressources destroyed divided by combined cost of itself,
        currently not normalized since I am lacking a good idea

fitness = (a*#win + b*#dst + c*#tkn + d*%dst + e*%tkn + f*frct) / (a+b+c+d+e+f)

a,b,c,d,e,f are linear factors to weight different score. A factor equal to zero takes a score out. 
The damage taken scores should be weighted negative since loss of ressource isn't really good.
```

The fitness function is as written here really crude and I doubt it to be very efficient, but I will test it this way first and then see how it is going.

### Evolution
After each fleet is scored a set fraction of the population should be killed and the others reproduce to refill the population. I will aim to kill have the population and I will try to do it with a random approach. This means that not the worst scored half is being killed, but the lower the score the lower the chance of survival. My completely made up approach to this is to assign a chance between 0.99 and 0.01 to all fleets decreasing linear is the score increases. Then starting with the lowest scored fleet and ascending a 100 sided die will be rolled. If the result is below the assigned chance, the fleet dies. This will be continued until half of the population is dead. If the best scored fleet is reached and there is still more than half the population alive, the process will restart with worst scored remaining fleet and roll a die again for all remaining fleets.

Now each fleet will reproduce and create one new fleet. This fleet will be the same as its parent enlarging the population and making survival more likely, unless a random mutation is triggered further driving evolution. I still have to decide how to exactly incorporate evolution, but the idea is, that if a mutation is triggered the type of mutation will be randomly decided. I identified 3 general areas. Change in fleet costs, change in allowed number of capital ships and change in fleet composition. At least one if these will be guaranteed to occur and multiple can occure together. There will also be a factor to decide on the intensity of mutation, but for lowest intensity I am thinking about increasing or decreasing the cost by 2, increasing or decreasing the capacity by 1, and adding one valid ship of a random type. After a change the computer will again buy ships for the fleet. If a random ship is added, this has to be bought first. If it is a fighter, then the following list has to include only ships with a capacity of at least one. Also the following lists in any case will only provide ships that have been in the fleet before in the amount that they have been in there before, until none of them can be bought anymore. Then the normal ship picking list will be used until there is no valid pick left.

### Trivia
I will try to provide unique labels for each species to be able to generate a family tree after the simulation. Also all factors, caps and what not should be changeable via a config file.

## Results
Pending...
